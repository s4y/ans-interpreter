<!DOCTYPE html>
<script id="helloWorld" type="text/ans">

$"Hello, World!"

</script>
<script id="fact" type="text/ans">

Func Fac 1 `BB
    If Or =_a 1  =_a 0 `B
       Set _ _a
       @
    Set _ + 1 Fac - _a 1 
    @

</script>
<script>
	function Lexer(rules){
		this.rules = rules;
	}
	Lexer.prototype.lex = function(code){
		var i, l = this.rules.length, tokens = [], match, rule;
		token:
		while (code.length) {
			for (i = 0; i < l; i++) {
				rule = this.rules[i];
				if ((match = code.match(rule.expr))) {
					code = code.substring(match[0].length);
					if (rule.type) {
						tokens.push({ type: rule.type, value: ('fn' in rule) ? rule.fn(match) : match[0] });
					}
					continue token;
				}
			}
			// No rules matched
			throw new Error("Syntax error");
		}
		return tokens;
	};
	var lexer = new Lexer([
		{ expr: /^\s+/, type: null },
		{ expr: /^_[a-z]*/, type: 'variable' },
		{ expr: /^"([^"]*)"/, type: 'list', fn: function(match){ return match[1].split(''); } },
		{ expr: /^\d/, type: 'number', fn: function(match){ return +match[0]; } },
		{ expr: /^[A-Z][a-z]*/, type: 'function' },
		{ expr: /^[^A-Za-z]/, type: 'function' }
	]);

	function AnsFunction(argc, body){ this.argc = argc; this.body = body; }
	AnsFunction.prototype.run = function(){
		throw new Error("I am not good with computer how did I get here?");
	}

	function NativeAnsFunction(argc, handler){
		this.argc = argc;
		this.handler = handler;
	}
	NativeAnsFunction.prototype = new AnsFunction();
	NativeAnsFunction.prototype.run = function(args){
		return this.handler.apply(undefined, args);
	}

	function Ans(globalEnv){ this.globalEnv = globalEnv; }
	Ans.prototype.run = function(expressions){
		return this.runInEnvironment(expressions, this.globalEnv);
	};
	// Warning: consumes `expressions`
	Ans.prototype.runInEnvironment = function(expressions, env){
		var expr = expressions.shift(), args, ret = null;
		if (expr.type === 'function'){
			fn = env[expr.value];
			if ( ! fn) {
				throw new Error("No function named " + expr.value);
			}
			args = expressions.splice(0, fn.argc);
			if (args.length < fn.argc) {
				throw new Error("Not enough arguments to " + expr.value);
			}
			ret = fn.run(args);
		} else if (expr.type in {'list': true, 'number': true }) {
			ret = expr;
		} else if (expr.type === 'variable') {
			if (expr.value in env) {
				ret = env[expr.value];
			} else {
				throw new Error(expr.value + " is not defined");
			}
		} else {
			throw new Error("No idea what to do with a value of type " + expr.type);
		}
		if (expressions.length) {
			throw new Error("Unexpected value");
		}
		return ret;
	};

	var env = {
		'$': new NativeAnsFunction(1, function(str){
			if (str.type !== 'list') {
				throw new Error('$ expected a list');
			}
			console.log(str.value.join(''));
		})
	};
	var interp = new Ans(env);


	var code = document.getElementById('helloWorld').firstChild.nodeValue.trim();
	console.log(code);
	var tokens = lexer.lex(code);
	console.log(JSON.stringify(tokens, null, '\t'));

	interp.run(tokens);

</script>

